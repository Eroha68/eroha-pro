name: üöÄ Auto Deploy to Hugging Face Space

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: üîÑ Redeploy Hugging Face Space with Changelog
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üïì Generate changelog (last 10 commits)
        id: changelog
        run: |
          echo "üìù Generating changelog..."
          echo "### üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–º–º–∏—Ç–æ–≤" > changelog.md
          git log -10 --pretty=format:'- %ad ‚Ä¢ `%h` ‚Äî %s' --date=format:'%Y-%m-%d %H:%M' >> changelog.md
          echo "" >> changelog.md
          echo "### üìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" >> changelog.md
          git diff --name-only HEAD~1 HEAD | sed 's/^/- /' >> changelog.md
          echo "" >> changelog.md
          cat changelog.md
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          cat changelog.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üîê Authenticate with Hugging Face
        run: |
          echo "machine huggingface.co login ${{ secrets.HF_TOKEN }}" > ~/.netrc

      - name: üöÄ Trigger Space rebuild
        run: |
          echo "=============================================="
          echo "üîÅ Redeploying Hugging Face Space: Eroha Agent"
          echo "=============================================="
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.HF_TOKEN }}" \
            https://huggingface.co/api/spaces/Yermek68/eroha-agentapi/restart
          echo ""
          echo "‚úÖ Redeploy triggered successfully!"
          echo ""
          echo "=============================================="
          echo "üìú CHANGELOG"
          echo "=============================================="
          echo "${{ env.CHANGELOG }}"
