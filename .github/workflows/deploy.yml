name: üöÄ Auto Deploy to Hugging Face Space (Production Ready)

on:
  push:
    branches: [main]
    # üîç –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
    paths:
      - "app.py"
      - "src/**"
      - "requirements.txt"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    name: üß† Smart Redeploy with Tests, Health Check & Alerts
    runs-on: ubuntu-latest

    steps:
      # === 1Ô∏è‚É£ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ===
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      # === 2Ô∏è‚É£ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è changelog ===
      - name: üìù Generate changelog (last 10 commits)
        id: changelog
        run: |
          echo "üß± Generating changelog..."
          echo "### üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–º–º–∏—Ç–æ–≤" > changelog.md
          git log -10 --pretty=format:'- `%ad` ‚Äî %h ‚Äî %s' --date=format:'%Y-%m-%d %H:%M' >> changelog.md
          echo -e "\n\n### üìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã" >> changelog.md
          git diff --name-only HEAD~1 HEAD | sed 's/^/- /' >> changelog.md

      # === 3Ô∏è‚É£ Pre-deploy sanity check ===
      - name: üß™ Run sanity checks
        run: |
          echo "üß© Running syntax and dependency checks..."
          python3 -m py_compile app.py || { echo "‚ùå Syntax error in app.py"; exit 1; }
          pip install -r requirements.txt
          echo "‚úÖ Python syntax and dependencies OK."

      # === 4Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Hugging Face Space ===
      - name: üîë Clone target Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "üîê Authenticating with Hugging Face..."
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git clone https://Yermek68:${HF_TOKEN}@huggingface.co/spaces/Yermek68/eroha-agentapi repo

      # === 5Ô∏è‚É£ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å rsync ===
      - name: üîÑ Sync changes to Space
        run: |
          echo "‚öôÔ∏è Syncing repository contents..."
          rsync -av --delete --exclude='.git' --exclude='.github' ./ repo/

      # === 6Ô∏è‚É£ Commit & Push ===
      - name: üöÄ Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd repo
          git add .
          git commit -m "Auto deploy from GitHub CI ($(date '+%Y-%m-%d %H:%M'))" || echo "üü° No changes to commit."
          git push https://Yermek68:${HF_TOKEN}@huggingface.co/spaces/Yermek68/eroha-agentapi main
          echo "‚úÖ Deployment pushed successfully."

      # === 7Ô∏è‚É£ Health Check ===
      - name: ü©∫ Verify Space Health
        run: |
          echo "üîç Checking if Hugging Face Space is live..."
          sleep 30
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://huggingface.co/spaces/Yermek68/eroha-agentapi)
          if [ "$STATUS" != "200" ]; then
            echo "‚ùå Space returned status $STATUS"
            echo "Deployment failed." > deploy_status.txt
            exit 1
          else
            echo "‚úÖ Space responded with 200 OK"
            echo "Deployment succeeded." > deploy_status.txt
          fi

      # === 8Ô∏è‚É£ Telegram Notification ===
      - name: üì¢ Notify Telegram
        if: always()  # –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ —Å–±–æ–µ
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_USER_ID: ${{ secrets.ALLOWED_USER_ID }}
        run: |
          echo "üì® Sending Telegram notification..."
          MESSAGE=$(cat deploy_status.txt || echo "‚ö†Ô∏è Deployment status unknown")
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
              -d chat_id=${ALLOWED_USER_ID} \
              -d text="üîî *Hugging Face Deploy Report*\n\n${MESSAGE}\n\n$(cat changelog.md)" \
              -d parse_mode="Markdown"

      # === 9Ô∏è‚É£ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ ===
      - name: ‚úÖ Complete
        run: echo "üéâ Deployment pipeline finished."
