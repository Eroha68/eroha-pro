name: Eroha Core CI/CD

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 9 * * *' # –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 09:00 UTC

permissions:
  contents: write  # üëà —Ä–∞–∑—Ä–µ—à–∞–µ–º –±–æ—Ç—É –ø—É—à–∏—Ç—å —Ç–µ–≥–∏ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–µ–ª–∏–∑—ã

jobs:
  validate-core:
    name: üß© –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest
    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º YAML-—Ñ–∞–π–ª—ã
        run: |
          pip install yamllint
          yamllint . || true

      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON-—Ñ–∞–π–ª—ã
        run: |
          for f in $(find . -name "*.json"); do
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º $f"
            python -m json.tool < $f > /dev/null || exit 1
          done

      - name: üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        run: |
          if [ -f ErohaPRO_Implementation_Plan_v1.md ]; then
            sha256sum ErohaPRO_Implementation_Plan_v1.md || true
          else
            echo "–§–∞–π–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥."
          fi

  powershell-check:
    name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ PowerShell-—Å–∫—Ä–∏–ø—Ç–æ–≤
    runs-on: windows-latest
    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PowerShell-—Ñ–∞–π–ª–æ–≤
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $psFiles = Get-ChildItem -Path . -Recurse -Include *.ps1 -ErrorAction SilentlyContinue
          if ($psFiles.Count -eq 0) {
            Write-Host "PowerShell —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —à–∞–≥ –ø—Ä–æ–ø—É—â–µ–Ω."
          } else {
            foreach ($file in $psFiles) {
              Write-Host "–ü—Ä–æ–≤–µ—Ä—è–µ–º $($file.FullName)"
              try {
                pwsh -NoLogo -NoProfile -Command "Get-Command '$($file.FullName)' | Out-Null"
              } catch {
                Write-Error "–û—à–∏–±–∫–∞ –≤ $($file.FullName): $_"
                exit 1
              }
            }
          }

  build-archive:
    name: üì¶ –°–±–æ—Ä–∫–∞ –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —è–¥—Ä–∞ Eroha Core
    runs-on: ubuntu-latest
    needs: [validate-core, powershell-check]
    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: üóúÔ∏è –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ —è–¥—Ä–∞
        run: |
          mkdir -p artifacts
          zip -r artifacts/ErohaSuite_Core.zip . -x "*.git*" ".github/*" "__pycache__/*"

      - name: üöÄ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: ErohaSuite_Core_Build
          path: artifacts/ErohaSuite_Core.zip

  release:
    name: üèÅ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–µ–ª–∏–∑–∞
    runs-on: ubuntu-latest
    needs: [build-archive]
    steps:
      - name: üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Ç—ç–≥–∞–º–∏
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üßÆ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤–µ—Ä—Å–∏–∏
        id: version
        run: |
          TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$TAG" ]; then
            NEW_TAG="v1.0.0"
          else
            BASE=${TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
            PATCH=$((PATCH + 1))
            NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "üîñ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: $NEW_TAG"

      - name: üßæ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è changelog (10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–º–∏—Ç–æ–≤)
        id: changelog
        run: |
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          git log -n 10 --pretty=format:"- %s (%an, %ad, %h)" --date=short >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üìÇ –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ç–µ–≥–∞
        id: changed_files
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | sed -n 2p)
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          if [ -z "$PREV_TAG" ]; then
            git diff --name-only HEAD~10 >> $GITHUB_ENV
          else
            git diff --name-only $PREV_TAG HEAD >> $GITHUB_ENV
          fi
          echo "" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: üè∑Ô∏è –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ç–µ–≥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git tag $NEW_TAG
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git $NEW_TAG

      - name: üöÄ –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–ª–∏–∑ –Ω–∞ GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: "Eroha Core Release ${{ env.NEW_TAG }}"
          body: |
            üá∑üá∫ **–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞**
            –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —è–¥—Ä–∞ Eroha Core —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π CI/CD, –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –≤–µ—Ä—Å–∏–π –∏ changelog.

            üá∞üáø **–†–µ–ª–∏–∑ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã**
            Eroha Core —è–¥—Ä–æ—Å—ã–Ω—ã“£ –∂–∞“£–∞ –Ω“±—Å“õ–∞—Å—ã. CI/CD –∂–∞“õ—Å–∞—Ä—Ç—ã–ª–¥—ã, –Ω“±—Å“õ–∞–ª–∞—Ä –∂”ô–Ω–µ ”©–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä —Ç—ñ–∑—ñ–º—ñ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂–∞—Å–∞–ª–∞–¥—ã.

            üß© **–ò–∑–º–µ–Ω–µ–Ω–∏—è (Changelog)**
            ${{ env.CHANGELOG }}

            üìÇ **–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**
            ${{ env.CHANGED_FILES }}

            üóìÔ∏è –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞: ${{ github.event.head_commit.timestamp }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
          files: artifacts/ErohaSuite_Core.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
